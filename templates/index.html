<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>–ì—Ä–∞—Ñ–∏–∫ –¥–µ–∂—É—Ä—Å—Ç–≤</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}?v={{ version }}">
</head>

<body>
    <div class="background-animation"></div>
    <div class="container-tv">
        <!-- –°–µ–≥–æ–¥–Ω—è—à–Ω–∏–π –¥–µ–∂—É—Ä–Ω—ã–π -->
        <div class="today-section glass-effect">
            <div class="today-date">
                –°–µ–≥–æ–¥–Ω—è: <span id="today-date">{{ today.strftime('%d.%m.%Y') }}</span>
                <span class="time-separator">|</span>
                <span id="current-time">{{ current_time }}</span>
            </div>
            <div id="today-duty-container">
                {% if today_duty %}
                <div class="today-duty">
                    {% if today_duty.morning and today_duty.evening %}
                    <div class="duty-line">
                        <span class="duty-label">–£—Ç—Ä–æ:</span> {{ today_duty.morning }}
                        <span class="duty-separator">|</span>
                        <span class="duty-label">–í–µ—á–µ—Ä:</span> {{ today_duty.evening }}
                    </div>
                    {% elif today_duty.morning %}
                    <div class="duty-line">
                        <span class="duty-label">–£—Ç—Ä–æ:</span> {{ today_duty.morning }}
                    </div>
                    {% elif today_duty.evening %}
                    <div class="duty-line">
                        <span class="duty-label">–í–µ—á–µ—Ä:</span> {{ today_duty.evening }}
                    </div>
                    {% else %}
                    <div class="no-duty">
                        –ù–∞ —Å–µ–≥–æ–¥–Ω—è –¥–µ–∂—É—Ä–Ω—ã–µ –Ω–µ –Ω–∞–∑–Ω–∞—á–µ–Ω—ã
                    </div>
                    {% endif %}
                </div>
                {% elif error %}
                <div class="error-duty">
                    ‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏
                </div>
                {% else %}
                <div class="no-duty">
                    –ù–∞ —Å–µ–≥–æ–¥–Ω—è –¥–µ–∂—É—Ä–Ω—ã–µ –Ω–µ –Ω–∞–∑–Ω–∞—á–µ–Ω—ã
                </div>
                {% endif %}
            </div>
        </div>

        <!-- –ë–ª–∏–∂–∞–π—à–∏–µ 2 –Ω–µ–¥–µ–ª–∏ –∏–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ -->
        <div class="schedule-section glass-effect" id="schedule-container">
            {% if error %}
            <!-- –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –æ—à–∏–±–∫–∏ -->
            <div class="error-container">
                <div class="alert alert-danger glass-effect">
                    <h4>‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–∞–Ω–Ω—ã—Ö</h4>
                    <p>{{ error }}</p>
                    <hr>
                    <small class="text-muted">
                        –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø–æ–≤—Ç–æ—Ä–Ω–∞—è –ø–æ–ø—ã—Ç–∫–∞ —á–µ—Ä–µ–∑ 15 —Å–µ–∫—É–Ω–¥...
                    </small>
                </div>
            </div>
            {% elif weeks %}
            <!-- –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è -->
            {% for week in weeks %}
            <div class="week-row glass-effect">
                <div class="row">
                    {% for duty in week %}
                    <div
                        class="col day-cell {% if duty.date == today %}today-highlight{% endif %} {% if duty.weekday == '–°–ë' %}saturday{% endif %} {% if duty.weekday == '–í–°' %}sunday{% endif %}">
                        <div class="date-header">
                            <span
                                class="weekday {% if duty.weekday == '–°–ë' %}saturday{% endif %} {% if duty.weekday == '–í–°' %}sunday{% endif %}">
                                {{ duty.weekday }}
                            </span>
                            {{ duty.date.strftime('%d.%m') }}
                        </div>
                        <div class="duty-name">
                            {% if duty.weekday == '–°–ë' or duty.weekday == '–í–°' %}
                            {# –°—É–±–±–æ—Ç–∞ –∏ –≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ - –∫–∞–∫ —Ä–∞–Ω—å—à–µ #}
                            {{ duty.evening|default('') }}
                            {% else %}
                            {# –ë—É–¥–Ω–∏ - —É—Ç—Ä–æ –∏ –≤–µ—á–µ—Ä –Ω–∞ —Ä–∞–∑–Ω—ã—Ö —Å—Ç—Ä–æ–∫–∞—Ö #}
                            {% if duty.morning %}
                            <div class="morning-line">–£—Ç—Ä–æ: {{ duty.morning }}</div>
                            {% endif %}
                            {% if duty.evening %}
                            <div class="evening-line">–í–µ—á–µ—Ä: {{ duty.evening }}</div>
                            {% endif %}
                            {% if not duty.morning and not duty.evening %}
                            <div class="no-duty-cell">‚Äî</div>
                            {% endif %}
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endfor %}
            {% else %}
            <div class="text-center text-muted py-4">
                –ù–µ—Ç –¥–µ–∂—É—Ä—Å—Ç–≤ –Ω–∞ –±–ª–∏–∂–∞–π—à–∏–µ 2 –Ω–µ–¥–µ–ª–∏
            </div>
            {% endif %}
        </div>

        <!-- –í—Ä–µ–º—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è -->
        <div class="last-updated glass-effect">
            –û–±–Ω–æ–≤–ª–µ–Ω–æ: <span id="last-updated-time"></span>
        </div>
    </div>

    <script>
        class DutyScheduleApp {
            constructor() {
                this.currentTimeElement = document.getElementById('current-time');
                this.lastUpdatedElement = document.getElementById('last-updated-time');
                this.todayDateElement = document.getElementById('today-date');
                this.todayDutyContainer = document.getElementById('today-duty-container');
                this.scheduleContainer = document.getElementById('schedule-container');

                this.serverNTPTime = null;
                this.dataUpdateInterval = null;
                this.timeUpdateInterval = null;
                this.isFetching = false;

                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –≤—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
                this.updateLastUpdatedTime(new Date().toLocaleTimeString('ru-RU', {
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                }));

                this.init();
            }

            init() {
                console.log('üöÄ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è...');

                // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Å—Ä–∞–∑—É
                this.fetchData();

                // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
                this.dataUpdateInterval = setInterval(() => this.fetchData(), 30000);

                // –û–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è –∫–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É
                this.updateLocalTime();
                this.timeUpdateInterval = setInterval(() => this.updateLocalTime(), 1000);

                // –ü–ª–∞–≤–Ω–æ–µ –ø–æ—è–≤–ª–µ–Ω–∏–µ
                document.body.style.opacity = '0';
                document.body.style.transition = 'opacity 0.5s ease-in-out';
                setTimeout(() => {
                    document.body.style.opacity = '1';
                }, 100);
            }

            async fetchData() {
                // –ï—Å–ª–∏ —É–∂–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –∑–∞–ø—Ä–æ—Å - –ø—Ä–æ–ø—É—Å–∫–∞–µ–º
                if (this.isFetching) {
                    console.log('‚è≥ –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –∑–∞–ø—Ä–æ—Å: —É–∂–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è');
                    return;
                }

                this.isFetching = true;

                try {
                    // –î–æ–±–∞–≤–ª—è–µ–º —Å–ª—É—á–∞–π–Ω—ã–π –ø–∞—Ä–∞–º–µ—Ç—Ä –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è
                    const timestamp = Date.now();
                    const random = Math.random().toString(36).substring(7);

                    const response = await fetch(`/api/data?_=${timestamp}&r=${random}`, {
                        headers: {
                            'Cache-Control': 'no-cache',
                            'Pragma': 'no-cache'
                        },
                        cache: 'no-store'
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}`);
                    }

                    const data = await response.json();

                    if (data.success) {
                        this.processData(data.data);

                        // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è (–ª–æ–∫–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è –∫–ª–∏–µ–Ω—Ç–∞)
                        const now = new Date();
                        const updateTime = now.toLocaleTimeString('ru-RU', {
                            hour: '2-digit',
                            minute: '2-digit',
                            second: '2-digit'
                        });
                        this.updateLastUpdatedTime(updateTime);

                        console.log('‚úÖ –î–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω—ã:', now.toLocaleTimeString());
                    } else {
                        throw new Error('Invalid response');
                    }

                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö:', error);
                } finally {
                    this.isFetching = false;
                }
            }

            processData(data) {
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–µ—Ä–≤–µ—Ä–Ω–æ–µ –≤—Ä–µ–º—è –∏–∑ timestamp
                this.serverNTPTime = data.timestamp * 1000;

                // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞—Ç—É
                const today = new Date(data.today);
                this.todayDateElement.textContent = this.formatDate(today);

                // –û–±–Ω–æ–≤–ª—è–µ–º —Å–µ–≥–æ–¥–Ω—è—à–Ω–µ–≥–æ –¥–µ–∂—É—Ä–Ω–æ–≥–æ
                this.updateTodayDuty(data.today_duty);

                // –û–±–Ω–æ–≤–ª—è–µ–º —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ
                this.updateSchedule(data.weeks);
            }

            updateTodayDuty(todayDuty) {
                if (!todayDuty) {
                    this.todayDutyContainer.innerHTML = `
                    <div class="no-duty">
                        –ù–∞ —Å–µ–≥–æ–¥–Ω—è –¥–µ–∂—É—Ä–Ω—ã–µ –Ω–µ –Ω–∞–∑–Ω–∞—á–µ–Ω—ã
                    </div>
                `;
                    return;
                }

                const morning = todayDuty.morning || '';
                const evening = todayDuty.evening || '';

                let html = '<div class="today-duty">';

                if (morning && evening) {
                    html += `
                    <div class="duty-line">
                        <span class="duty-label">–£—Ç—Ä–æ:</span> ${morning}
                        <span class="duty-separator">|</span>
                        <span class="duty-label">–í–µ—á–µ—Ä:</span> ${evening}
                    </div>
                `;
                } else if (morning) {
                    html += `
                    <div class="duty-line">
                        <span class="duty-label">–£—Ç—Ä–æ:</span> ${morning}
                    </div>
                `;
                } else if (evening) {
                    html += `
                    <div class="duty-line">
                        <span class="duty-label">–í–µ—á–µ—Ä:</span> ${evening}
                    </div>
                `;
                } else {
                    html += `
                    <div class="no-duty">
                        –ù–∞ —Å–µ–≥–æ–¥–Ω—è –¥–µ–∂—É—Ä–Ω—ã–µ –Ω–µ –Ω–∞–∑–Ω–∞—á–µ–Ω—ã
                    </div>
                `;
                }

                html += '</div>';
                this.todayDutyContainer.innerHTML = html;
            }

            updateSchedule(weeks) {
                if (!weeks || weeks.length === 0) {
                    this.scheduleContainer.innerHTML = `
                    <div class="text-center text-muted py-4">
                        –ù–µ—Ç –¥–µ–∂—É—Ä—Å—Ç–≤ –Ω–∞ –±–ª–∏–∂–∞–π—à–∏–µ 2 –Ω–µ–¥–µ–ª–∏
                    </div>
                `;
                    return;
                }

                const today = new Date().toISOString().split('T')[0];
                let html = '';

                weeks.forEach(week => {
                    html += '<div class="week-row glass-effect"><div class="row">';

                    week.forEach(duty => {
                        const isToday = duty.date === today;
                        const isWeekend = duty.weekday === '–°–ë' || duty.weekday === '–í–°';
                        const dayClass = `col day-cell ${isToday ? 'today-highlight' : ''} ${isWeekend ? duty.weekday.toLowerCase() : ''}`;

                        html += `
                        <div class="${dayClass}">
                            <div class="date-header">
                                <div class="weekday ${isWeekend ? duty.weekday.toLowerCase() : ''}">
                                    ${duty.weekday}
                                </div>
                                ${duty.date_str}
                            </div>
                            <div class="duty-name">
                    `;

                        if (isWeekend) {
                            html += duty.evening || '';
                        } else {
                            if (duty.morning) {
                                html += `<div class="morning-line">–£—Ç—Ä–æ: ${duty.morning}</div>`;
                            }
                            if (duty.evening) {
                                html += `<div class="evening-line">–í–µ—á–µ—Ä: ${duty.evening}</div>`;
                            }
                            if (!duty.morning && !duty.evening) {
                                html += `<div class="no-duty-cell">‚Äî</div>`;
                            }
                        }

                        html += `
                            </div>
                        </div>
                    `;
                    });

                    html += '</div></div>';
                });

                this.scheduleContainer.innerHTML = html;
            }

            updateLocalTime() {
                if (!this.currentTimeElement) return;

                let now;
                if (this.serverNTPTime) {
                    const timeSinceServerUpdate = Date.now() - this.serverNTPTime;
                    now = new Date(this.serverNTPTime + timeSinceServerUpdate);
                } else {
                    now = new Date();
                }

                const timeString = now.toLocaleTimeString('ru-RU', {
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });

                this.currentTimeElement.textContent = timeString;
            }

            updateLastUpdatedTime(updateTime) {
                if (!this.lastUpdatedElement) return;
                this.lastUpdatedElement.textContent = updateTime;
            }

            formatDate(date) {
                return date.toLocaleDateString('ru-RU', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric'
                });
            }

            destroy() {
                if (this.timeUpdateInterval) clearInterval(this.timeUpdateInterval);
                if (this.dataUpdateInterval) clearInterval(this.dataUpdateInterval);
            }
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        document.addEventListener('DOMContentLoaded', () => {
            window.app = new DutyScheduleApp();

            // –û—á–∏—Å—Ç–∫–∞ –ø—Ä–∏ –≤—ã–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
            window.addEventListener('beforeunload', () => {
                if (window.app) {
                    window.app.destroy();
                }
            });
        });
    </script>
</body>

</html>